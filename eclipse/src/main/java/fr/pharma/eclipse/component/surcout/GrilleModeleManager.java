package fr.pharma.eclipse.component.surcout;

import java.util.SortedSet;

import javax.annotation.Resource;
import javax.faces.event.ActionEvent;
import javax.faces.event.AjaxBehaviorEvent;
import javax.faces.event.ValueChangeEvent;

import org.apache.commons.collections.CollectionUtils;
import org.primefaces.event.DateSelectEvent;

import fr.pharma.eclipse.component.BeanManager;
import fr.pharma.eclipse.component.surcout.validator.CategorieValidator;
import fr.pharma.eclipse.component.surcout.validator.GrilleValidator;
import fr.pharma.eclipse.component.surcout.validator.RegleValidator;
import fr.pharma.eclipse.domain.model.surcout.Categorie;
import fr.pharma.eclipse.domain.model.surcout.GrilleModele;
import fr.pharma.eclipse.domain.model.surcout.Theme;
import fr.pharma.eclipse.domain.model.surcout.regle.Regle;
import fr.pharma.eclipse.factory.common.BeanObjectFactory;
import fr.pharma.eclipse.predicate.GenericPredicate;
import fr.pharma.eclipse.service.common.GenericService;

/**
 * Description de la classe.
 * @author Netapsys
 * @version $Revision$ $Date$
 */
public class GrilleModeleManager extends BeanManager<GrilleModele> {

    /**
     * .SerialVersionUID.
     */
    private static final long serialVersionUID = -7920649122442884366L;

    /**
     * Theme.
     */
    private Theme theme;

    /**
     * Catégorie.
     */
    private Categorie categorie;

    /**
     * Factory de thème.
     */
    @Resource(name = "themeFactory")
    private BeanObjectFactory<Theme> themeFactory;

    /**
     * Factory de catégorie.
     */
    @Resource(name = "categorieFactory")
    private BeanObjectFactory<Categorie> categorieFactory;

    /**
     * Validateur de regle.
     */
    @Resource
    private RegleValidator regleValidator;
    /**
     * Validateur de regle.
     */
    @Resource
    private GrilleValidator grilleValidator;
    
    /**
     * Validateur de categorie
     */
    @Resource
    private CategorieValidator categorieValidator;

   

	/**
     * Regle.
     */
    private Regle regle;

    /**
     * Editable.
     */
    private boolean editable;

    /**
     * Constructeur.
     * @param service Service.
     */
    public GrilleModeleManager(final GenericService<GrilleModele> service) {
        super(service);
    }

    /**
     * Méthode en charge d'initialiser un thème.
     * @param event Envenement.
     */
    public void initTheme(final ActionEvent event) {
        final Theme t = (Theme) event.getComponent().getAttributes().get("theme");
        if (t == null) {
            this.theme = this.themeFactory.getInitializedObject();
            this.theme.setGrilleModele(this.getBean());
        } else {
            this.setTheme(t);
        }
    }

    /**
     * Calcul si la grille est éditable.
     */
    public void processEditable() {
        this.reattach();
        this.editable = (this.getBean().getId() == null) || this.getBean().getGrilles().isEmpty();
    }

    /**
     * Méthode en charge de mettre à jour et d'ajouter le thème en cours.
     */
    public void addTheme() {
        final SortedSet<Theme> themes = this.getBean().getThemes();
        if (!themes.contains(this.theme)) {
            themes.add(this.theme);
        }
        this.theme = null;
    }

    /**
     * Méthode en charge d'initialiser une catégorie.
     * @param event Envenement.
     */
    public void initCategorie(final ActionEvent event) {
        final Categorie c = (Categorie) event.getComponent().getAttributes().get("categorie");
        final Theme theme = (Theme) event.getComponent().getAttributes().get("theme");
        if (c == null) {
            this.categorie = this.categorieFactory.getInitializedObject();
            this.categorie.setTheme(theme);
            this.setTheme(theme);
        } else {
            this.setCategorie(c);
            this.setTheme(theme);
        }
    }

    /**
     * Méthode en charge de mettre à jour ou ajouter la catégorie en cours.
     */
    public void addCategorie() {
    	
    	if (!this.categorieValidator.validate(this.categorie)) {
            return;
        }
    	
        final SortedSet<Categorie> categories = this.theme.getCategories();
        //Si une catégorie ayant le même libellé n'est pas déjà présente dans ce theme
        if (!categories.contains(this.categorie)) {
            categories.add(this.categorie);
            SortedSet<Theme> themes = this.getBean().getThemes();
            Object theme = CollectionUtils.find(themes, new GenericPredicate("libelle", this.categorie.getTheme().getLibelle()));
            ((Theme)theme).getCategories().add(this.categorie);        
            this.categorie.setTheme(((Theme)theme));
        }else{
        	//TODO : afficher un message?
        }
             
        this.getService().save(this.getBean());
        
    }

    /**
     * Méthode en charge de supprimer une catégorie.
     * @param event L'évènement.
     */
    public void removeCategorie(final ActionEvent event) {
        final Categorie c = (Categorie) event.getComponent().getAttributes().get("categorie");
        c.getTheme().getCategories().remove(c);
    }

    /**
     * Méthode en charge de supprimer un thème.
     * @param event L'évènement.
     */
    public void removeTheme(final ActionEvent event) {
        final Theme t = (Theme) event.getComponent().getAttributes().get("theme");
        this.getBean().getThemes().remove(t);
    }

    /**
     * Méthode en charge d'initialiser une règle.
     * @param categorie La catégorie.
     */
    public void initRegle(final Categorie categorie) {
        this.regle = new Regle();
        this.regle.setCategorie(categorie);
    }

    /**
     * Listener vide (obligatoire car sinon le tag <f:ajax ..> ne fonctionne
     * pas.
     * @param event Evenement.
     */
    public void nothing(final AjaxBehaviorEvent event) {
        event.getComponent();
    }

    public void handleDateSelect(final DateSelectEvent event) {
        event.getComponent();
    }

    public void handleDateSelect(final ValueChangeEvent event) {
        event.getComponent();
    }

    /**
     * Méthode en charge d'ajouter une regle.
     */
    public void addRegle() {
        if (!this.regleValidator.validate(this.regle)) {
            return;
        }

        final SortedSet<Categorie> categories =
            ((Theme) CollectionUtils.find(this.getBean().getThemes(), new GenericPredicate("libelle", this.getRegle().getCategorie().getTheme().getLibelle()))).getCategories();
        final Categorie c = (Categorie) CollectionUtils.find(categories, new GenericPredicate("libelle", this.getRegle().getCategorie().getLibelle()));

        this.getRegle().setCategorie(c);
        c.getRegles().add(this.getRegle());

        if (!this.grilleValidator.validate(c)) {
            c.getRegles().remove(this.getRegle());
            return;
        }

        this.getService().save(this.getBean());
    }
    /**
     * Retourne <true> si la grille courante est éditable.
     * @return <true> si la grille courante est éditable.
     */
    public boolean isEditable() {
        return this.editable;
    }

    /**
     * Méthode en charge de supprimer une règle.
     * @param r La règle à supprimer.
     */
    public void removeRegle(final Regle r) {
        r.getCategorie().getRegles().remove(r);
    }

    /**
     * Setter pour themeFactory.
     * @param themeFactory le themeFactory à écrire.
     */
    public void setThemeFactory(final BeanObjectFactory<Theme> themeFactory) {
        this.themeFactory = themeFactory;
    }

    /**
     * Setter pour categorieFactory.
     * @param categorieFactory le categorieFactory à écrire.
     */
    public void setCategorieFactory(final BeanObjectFactory<Categorie> categorieFactory) {
        this.categorieFactory = categorieFactory;
    }

    /**
     * Getter sur theme.
     * @return Retourne le theme.
     */
    public Theme getTheme() {
        return this.theme;
    }

    /**
     * Setter pour theme.
     * @param theme le theme à écrire.
     */
    public void setTheme(final Theme theme) {
        this.theme = theme;
    }

    /**
     * Getter sur categorie.
     * @return Retourne le categorie.
     */
    public Categorie getCategorie() {
        return this.categorie;
    }

    /**
     * Setter pour categorie.
     * @param categorie le categorie à écrire.
     */
    public void setCategorie(final Categorie categorie) {
        this.categorie = categorie;
    }

    /**
     * Getter sur regle.
     * @return Retourne le regle.
     */
    public Regle getRegle() {
        return this.regle;
    }

    /**
     * Setter pour regle.
     * @param regle le regle à écrire.
     */
    public void setRegle(final Regle regle) {
        this.regle = regle;
    }

    /**
     * Setter pour regleValidator.
     * @param regleValidator le regleValidator à écrire.
     */
    public void setRegleValidator(final RegleValidator regleValidator) {
        this.regleValidator = regleValidator;
    }

    /**
     * Setter pour editable.
     * @param editable le editable à écrire.
     */
    public void setEditable(final boolean editable) {
        this.editable = editable;
    }
    
    /**
   	 * @return the categorieValidator
   	 */
   	public CategorieValidator getCategorieValidator() {
   		return categorieValidator;
   	}

   	/**
   	 * @param categorieValidator the categorieValidator to set
   	 */
   	public void setCategorieValidator(CategorieValidator categorieValidator) {
   		this.categorieValidator = categorieValidator;
   	}
}
